<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/gephi-lite/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="A lighter, web-based spin-off of Gephi" />
    <link rel="apple-touch-icon" href="/gephi-lite/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="/gephi-lite/manifest.json" />
    <title>Gephi Lite</title>
    <script type="module" crossorigin src="/gephi-lite/assets/index-D9MlyEIr.js"></script>
    <link rel="stylesheet" crossorigin href="/gephi-lite/assets/index-BmLzDUDx.css">
  
    <script>
      (function() {
        'use strict';
        
        // Configuration
        const SESSION_ENDPOINT = '/__session';
        const SYNC_INTERVAL = 5000;
        let syncTimer = null;
        let isLoading = false;
        
        // Utility functions
        function log(message, data) {
          console.log('[Gephi Session Manager]', message, data || '');
        }
        
        // Session storage utilities
        function serializeSessionStorage() {
          const data = {};
          for (let i = 0; i < sessionStorage.length; i++) {
            const key = sessionStorage.key(i);
            if (key) {
              try {
                data[key] = sessionStorage.getItem(key);
              } catch (e) {
                log('Error serializing key:', key);
              }
            }
          }
          return data;
        }
        
        function restoreSessionStorage(data) {
          if (!data || typeof data !== 'object') return;
          
          // Clear existing session storage
          sessionStorage.clear();
          
          // Restore data
          Object.keys(data).forEach(key => {
            try {
              sessionStorage.setItem(key, data[key]);
            } catch (e) {
              log('Error restoring key:', key);
            }
          });
        }
        
        // API functions
        async function loadSession() {
          if (isLoading) return;
          isLoading = true;
          
          try {
            log('Loading session from server...');
            const response = await fetch(SESSION_ENDPOINT, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            });
            
            if (response.ok) {
              const sessionData = await response.json();
              restoreSessionStorage(sessionData);
              log('Session loaded successfully', Object.keys(sessionData).length + ' keys');
            } else {
              log('Failed to load session:', response.status);
            }
          } catch (error) {
            log('Error loading session:', error.message);
          } finally {
            isLoading = false;
          }
        }
        
        async function saveSession() {
          if (isLoading) return;
          
          try {
            const sessionData = serializeSessionStorage();
            const keyCount = Object.keys(sessionData).length;
            
            if (keyCount === 0) {
              return;
            }
            
            log('Saving session to server...', keyCount + ' keys');
            const response = await fetch(SESSION_ENDPOINT, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(sessionData),
            });
            
            if (response.ok) {
              log('Session saved successfully');
            } else {
              log('Failed to save session:', response.status);
            }
          } catch (error) {
            log('Error saving session:', error.message);
          }
        }
        
        // Start periodic sync
        function startSync() {
          if (syncTimer) clearInterval(syncTimer);
          
          syncTimer = setInterval(() => {
            saveSession();
          }, SYNC_INTERVAL);
          
          log('Auto-sync started (interval: ' + SYNC_INTERVAL + 'ms)');
        }
        
        // Stop periodic sync
        function stopSync() {
          if (syncTimer) {
            clearInterval(syncTimer);
            syncTimer = null;
          }
        }
        
        // Initialize on page load
        async function initialize() {
          log('Initializing session persistence...');
          
          // Load session data before the app starts
          await loadSession();
          
          // Start periodic saving
          startSync();
          
          // Save session when page is about to unload
          window.addEventListener('beforeunload', () => {
            stopSync();
            // Use sendBeacon for reliable saving on page unload
            try {
              const sessionData = serializeSessionStorage();
              const blob = new Blob([JSON.stringify(sessionData)], {
                type: 'application/json'
              });
              navigator.sendBeacon(SESSION_ENDPOINT, blob);
              log('Session saved via beacon on page unload');
            } catch (error) {
              log('Error saving session on unload:', error.message);
            }
          });
          
          // Handle visibility changes (tab switching, etc.)
          document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
              saveSession();
            }
          });
          
          log('Session persistence initialized successfully');
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initialize);
        } else {
          initialize();
        }
        
        // Expose utilities to global scope for debugging
        window.gephiSessionManager = {
          loadSession,
          saveSession,
          serializeSessionStorage,
          restoreSessionStorage,
          startSync,
          stopSync
        };
      })();
    </script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <div id="portal-target"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
